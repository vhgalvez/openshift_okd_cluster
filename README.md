
# OpenShift OKD

This project provisions a single node OpenShift OKD cluster on KVM/QEMU VM's. Infrastructure is provisioned using terraform and the cluster is created using the User-provisioned infrastructure (UPI) method.

# Important
When using okd, make sure to download the openshift tools for okd. The redhat provided tools will not work on fedora coreos[^1].

# Setup
## vm's
|hostname           |cpu's |memory (mib) |ip address    |
|-------------------|------|-------------|--------------|
|okd-bootstrap      |4     |15260        |192.168.150.3 |
|okd-controlplane-1 |4     |15260        |192.168.150.10|
|okd-controlplane-2 |4     |15260        |192.168.150.11|
|okd-controlplane-3 |4     |15260        |192.168.150.12|

## cluster
|name |domain  |url                                                  |
|-----|--------|-----------------------------------------------------|
|local|okd.lab |https://console-openshift-console.apps.local.okd.lab |


# Pre-requisites
Do these steps before opening the project in a devcontainer.
- Download and unzip the Fedora CoreOS QEMU image into `./coreos`[^2] (create the folder if it doesn't exist)
- Download openshift-install and extract it into `./.devcontainer/tools`[^3][^4] (create the folder if it doesn't exist)
- Setup dnsmasq so everything can be resolved
    ```bash
    address=/okd.lab/10.17.3.1   # bootstrap
    address=/okd.lab/10.17.3.10   # controlplane 1 
    address=/okd.lab/10.17.3.11   # controlplane 2
    address=/okd.lab/110.17.3.12   # controlplane 3
    ```
- RedHat pull secret[^5]
- Copy [install-config.yaml.template](install-config.yaml.template) to [install-config.yaml](install-config.yaml) and fill in the required values. The install-config.yaml file is used to generate the ignition files[^6].

Following steps can be done within the devcontainer.
- Generate ignition configuration files
    ```bash
    openshift-install create ignition-configs --dir ignition_configs/
    ```

# Provision OpenShift OKD
- Create the infrastructure
    ```bash
    cd terraform
    terraform init
    terraform apply -auto-approve
    ```
- Install the bootstrap node
    ```bash
    cd ignition_configs
    openshift-install wait-for bootstrap-complete --log-level=debug
    ```
- At this point the bootstrap node can be destroyed
    ```bash
    cd terraform
    terraform destroy -target module.domain.libvirt_domain.okd_bootstrap
    ```
- Install the cluster
    ```bash
    cd ignition_configs
    openshift-install wait-for install-complete --log-level=debug
    ```

# References
- https://www.okd.io/
- https://www.okd.io/installation/#plan-your-installation
- https://www.okd.io/guides/upi-sno/#architecture-this-refers-to-a-full-high-availability-cluster
- https://docs.fedoraproject.org/en-US/fedora-coreos
- https://docs.openshift.com/container-platform/4.13/installing/installing_platform_agnostic/installing-platform-agnostic.html

[^1]: https://shivering-isles.com/til/2021/07/openshift-installer-is-not-openshift-installer
[^2]: https://fedoraproject.org/coreos/download
[^3]: https://github.com/okd-project/okd/tags
[^4]: https://amd64.origin.releases.ci.openshift.org/
[^5]: https://console.redhat.com/openshift/downloads
[^6]: https://docs.openshift.com/container-platform/4.13/installing/installing_platform_agnostic/installing-platform-agnostic.html#installation-initializing-manual_installing-platform-agnostic




  sudo cat /etc/dnsmasq.conf
  sudo systemctl restart dnsmasq
  clear
 sudo systemctl status dnsmasq
 cleaer

sudo setenforce 0
sudo systemctl restart libvirtd


# Cambiar el propietario y grupo de todos los archivos en el directorio /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs
sudo chown -R $user:$user /home/$user/openshift_okd_cluster/terraform/ignition_configs
sudo chmod -R 775 /home/$user/openshift_okd_cluster/terraform/ignition_configs

# Asegurar permisos de escritura en los archivos dentro del directorio ignition_configs
sudo chmod -R u+w /home/$user/openshift_okd_cluster/terraform/ignition_configs


openshift-install create ignition-configs --dir=/home/victory/openshift_okd_cluster/terraform/ignition_configs --log-level=debug




export KUBECONFIG=~/.kube/config

mkdir -p ~/.kube
sudo chown -R core:core /var/home/core/.kube
mv /var/home/core/.kube/auth/kubeconfig /var/home/core/.kube/config

export KUBECONFIG=/var/home/core/.kube/config
oc get nodes


sudo setenforce 0
sudo systemctl restart libvirtd


sudo nano /etc/resolv.conf
# Generated by NetworkManager
search okd.lab
nameserver 192.168.0.18
nameserver 10.17.3.1

sudo nano /etc/sysconfig/network-scripts/ifcfg-enp4s0f1
  GNU nano 5.6.1 /etc/sysconfig/network-scripts/ifcfg-enp4s0f1  Modificado
DEVICE=enp4s0f1
BOOTPROTO=dhcp
ONBOOT=yes



GNU nano 5.6.1 /etc/sysconfig/network-scripts/ifcfg-enp4s0f1  Modificado
BOOTPROTO=none
IPADDR=192.168.0.25     # IP deseada
NETMASK=255.255.255.0   # Máscara de subred
GATEWAY=192.168.0.1     # Puerta de enlace predeterminada
DNS1=8.8.8.8            # Servidor DNS primario
DNS2=8.8.4.4            # Servidor DNS secundario (opcional)


sudo nmcli device disconnect enp4s0f1
El dispositivo «enp4s0f1» ha sido desconectado correctamente.
sudo nmcli device connect enp4s0f1
El dispositivo «enp4s0f1» se activó correctamente con «5f22d25b-6f79-4be7-b25a-94f1de0eb1aa».
[victory@physical1 ~]$

sudo systemctl restart NetworkManager



sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift -r /home/victory/openshift_okd_cluster/terraform/ignition_configs/auth core@10.17.3.3:/var/home/core/.kube

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift -r /home/victory/openshift_okd_cluster/terraform/ignition_configs/auth core@10.17.3.10:/var/home/core/.kube

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift -r /home/victory/openshift_okd_cluster/terraform/ignition_configs/auth core@10.17.3.11:/var/home/core/.kube

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift -r /home/victory/openshift_okd_cluster/terraform/ignition_configs/auth core@10.17.3.12:/var/home/core/.kube




 sudo virsh list


 # Cambiar el propietario y grupo de todos los archivos en el directorio /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs
sudo chown -R victory:victory /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs
sudo chmod -R 775 /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs

# Asegurar permisos de escritura en los archivos dentro del directorio ignition_configs
sudo chmod -R u+w /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs


openshift-install create ignition-configs --dir=/home/$USER/openshift_okd_cluster/terraform/ignition_configs --log-level=debug




sudo setenforce 0
sudo systemctl restart libvirtd

sudo cat /etc/resolv.conf

sudo nano /etc/resolv.conf
# Generated by NetworkManager
search okd.lab
nameserver 192.168.0.25
nameserver 10.17.3.1



sudo cat /etc/dnsmasq.conf

sudo systemctl status dnsmasq
sudo systemctl restart dnsmasq


sudo virsh list

sudo virsh shutdown okd-controlplane-1
sudo virsh shutdown okd-controlplane-2
sudo virsh shutdown okd-controlplane-3
sudo virsh shutdown okd-bootstrap

sudo virsh start okd-controlplane-1
sudo virsh start okd-controlplane-2
sudo virsh start okd-controlplane-3
sudo virsh start okd-bootstrap
sudo virsh net-start kube_network_02


address=/okd.lab/192.168.150.3    # bootstrap
address=/okd.lab/192.168.150.10   # controlplane 1 
address=/okd.lab/192.168.150.11   # controlplane 2
address=/okd.lab/192.168.150.12   # controlplane 3


sudo systemctl status dnsmasq
sudo systemctl restart dnsmasq




sudo ssh -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift core@192.168.150.10  -p 22

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift /home/$USER/openshift_okd_cluster/terraform/ignition_configs/auth/kubeconfig core@192.168.150.3:/var/home/core/.kube/config

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift /home/$USER/openshift_okd_cluster/terraform/ignition_configs/auth/kubeconfig core@192.168.150.10:/var/home/core/.kube/config

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift /home/$USER/openshift_okd_cluster/terraform/ignition_configs/auth/kubeconfig core@192.168.150.11:/var/home/core/.kube/config


sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift /home/$USER/openshift_okd_cluster/terraform/ignition_configs/auth/kubeconfig core@192.168.150.12:/var/home/core/.kube/config

mkdir -p /var/home/core/.kube
export KUBECONFIG=/var/home/core/.kube/config

sudo timedatectl set-ntp true
timedatectl status

sudo timedatectl set-timezone Europe/Madrid


sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift  /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs/auth/kubeconfig core@10.17.3.3:/var/home/core/.kube/config

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift  /home/victory/okd_cluster_openshift_fedora_coreos_kvm/nat_network_02/ignition_configs/auth/kubeconfig core@10.17.3.10:/var/home/core/.kube/config



sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift  /home/victory/openshift-okd/terraform/ignition_configs/auth/kubeconfig core@192.168.150.10:/var/home/core/.kube/config

sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift  /home/victory/openshift-okd/terraform/ignition_configs/auth/kubeconfig core@192.168.150.3:/var/home/core/.kube/config

sudo systemctl status libvirtd


sudo systemctl stop systemd-resolved
sudo systemctl disable systemd-resolved
sudo systemctl status systemd-resolved
__

4. Check libvirt Configuration Files
Ensure that /etc/libvirt/libvirtd.conf allows TCP connections to qemu:///system. Open the configuration file:

bash
Copiar código
sudo nano /etc/libvirt/libvirtd.conf
Look for the following lines and ensure they’re set correctly:

plaintext
Copiar código
unix_sock_group = "libvirt"
unix_sock_rw_perms = "0770"
After updating, restart the service:

bash
Copiar código
sudo systemctl restart libvirtd


sudo ssh -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift core@192.168.150.10  -p 22


mkdir -p /var/home/core/.kube
export KUBECONFIG=/var/home/core/.kube/config




sudo scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift /home/victory/openshift_okd_cluster/terraform/ignition_configs/auth/kubeconfig core@192.168.150.10:/var/home/core/.kube/config


sudo timedatectl set-ntp true
timedatectl status

sudo timedatectl set-ntp true
sudo timedatectl status
date